# 垃圾回收（GC, garbage collection）

在 JS 中，内存管理是自动运行的，开发者无从感知。

当我们创建变量、对象、函数等内容时，都需要消耗内存。那当我们用完这些东西时，JS 引擎是如果发现并清理占用的内存的呢？



## 可触达 | reachability

可触达是 JS 的内存管理的核心概念。当一个变量可以通过某种方式访问到，则认为该变量是可触达的

1. JS 中有些固定的变量(根变量 root)是可触达的，一定不会被删除
   - 全局变量
   - 当前函数的变量及参数
   - 当前调用链中，用于其他函数的变量和参数（闭包）
2. 如果存在变量被上述变量引用，我们也认为这个变量是可触达的



JS 的垃圾回收机制会监听这些变量，并删除不可触达的变量



## 内部算法

基本的垃圾回收算法可以称之为：标记清理法

通常有以下几个步骤：

1. 标记所有根变量
2. 标记根变量引用到的变量
3. 所有访问过的变量会被记录下来，以防再次被访问&标记
4. 所有未被标记过的变量将被删除



## 优化

为了避免垃圾回收影响到运行的代码，并加快垃圾回收的速度，JS 引擎做了一些优化策略

- 新老生代回收（generational collection）：会根据变量创建的时间划分新旧生代，新生代比老生代的扫描频率会高一些
- 增量回收（incremental collection）：如果变量过多，一次性扫描回收会占用比较多的时间，导致延迟了运行时代码。所以 JS 引擎会将垃圾回收的工作进行拆分，分布执行。这里会占用部分内存用于拆分标记
- 闲时回收(idel collection)：当 cpu 空闲时再进行垃圾回收



**参考资料**

1. <Garbage collection>, 2020-07-01, https://javascript.info/garbage-collection

   